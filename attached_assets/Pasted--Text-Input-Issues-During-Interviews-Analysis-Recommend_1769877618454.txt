# Text Input Issues During Interviews — Analysis & Recommendations                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                              
 **Date:** January 31, 2026                                                                                                                                                                                                                                                   
 **Scope:** `client/src/pages/interview.tsx`, `server/voice-interview.ts`                                                                                                                                                                                                     
 **Related commit:** `d193b46` — "Fix out-of-order chat messages during live interviews"                                                                                                                                                                                      
                                                                                                                                                                                                                                                                              
 ---                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                              
 ## Summary                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                              
 The recent fix for voice transcript ordering (commit `d193b46`) added reordering logic to the `user_transcript` WebSocket handler so that voice transcripts are inserted before streaming AI responses. However, the text input path (`handleSendText`) was not updated with 
  equivalent logic, and has several independent bugs that affect usability.                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                              
 ---                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                              
 ## Issues Found                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                              
 ### Issue 1: `isSendingText` State Is Effectively a No-Op (High Priority)                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                              
 **File:** `client/src/pages/interview.tsx:756-777`                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                              
 ```typescript                                                                                                                                                                                                                                                                
 setIsSendingText(true);       // line 756                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                              
 // ... synchronous operations ...                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                              
 setTextInput("");              // line 776                                                                                                                                                                                                                                   
 setIsSendingText(false);       // line 777 — same synchronous call frame                                                                                                                                                                                                     
 ```                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                              
 `setIsSendingText(true)` and `setIsSendingText(false)` are called in the same synchronous execution frame. React batches these state updates, so the `true` value is never rendered. The input field and send button are `disabled` when `isSendingText` is true, but since  
 the state never actually flips to `true` in any rendered frame, this guard does nothing.                                                                                                                                                                                     
                                                                                                                                                                                                                                                                              
 **Impact:** The disabled states on the input and send button (`lines 1012, 1019`) never activate. Rapid double-clicks or fast Enter key presses could send duplicate messages.                                                                                               
                                                                                                                                                                                                                                                                              
 **Recommendation:** Either remove `isSendingText` entirely (since WebSocket `.send()` is non-blocking and doesn't need a loading state), or implement it properly with server acknowledgment:                                                                                
                                                                                                                                                                                                                                                                              
 ```typescript                                                                                                                                                                                                                                                                
 const handleSendText = () => {                                                                                                                                                                                                                                               
   if (!textInput.trim() || !wsRef.current || wsRef.current.readyState !== WebSocket.OPEN) return;                                                                                                                                                                            
                                                                                                                                                                                                                                                                              
   const text = textInput.trim();                                                                                                                                                                                                                                             
   setTextInput("");  // Clear immediately to prevent double-send                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                              
   // Add to transcript with ordering check (see Issue 2)                                                                                                                                                                                                                     
   setTranscript((prev) => {                                                                                                                                                                                                                                                  
     const newEntry = { speaker: "respondent" as const, text, timestamp: Date.now() };                                                                                                                                                                                        
     const lastEntry = prev[prev.length - 1];                                                                                                                                                                                                                                 
     if (lastEntry && lastEntry.speaker === "alvia" && lastEntry.isStreaming) {                                                                                                                                                                                               
       return [...prev.slice(0, -1), newEntry, lastEntry];                                                                                                                                                                                                                    
     }                                                                                                                                                                                                                                                                        
     return [...prev, newEntry];                                                                                                                                                                                                                                              
   });                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                              
   wsRef.current.send(JSON.stringify({ type: "text_input", text }));                                                                                                                                                                                                          
 };                                                                                                                                                                                                                                                                           
 ```                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                              
 ---                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                              
 ### Issue 2: Text Input Bypasses Transcript Ordering Logic (High Priority)                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                              
 **File:** `client/src/pages/interview.tsx:758-766`                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                              
 The voice transcript ordering fix (commit `d193b46`) added this logic at **line 478** for voice:                                                                                                                                                                             
 ```typescript                                                                                                                                                                                                                                                                
 // If the last entry is a streaming AI response, insert user transcript before it                                                                                                                                                                                            
 const lastEntry = prev[prev.length - 1];                                                                                                                                                                                                                                     
 if (lastEntry && lastEntry.speaker === "alvia" && lastEntry.isStreaming) {                                                                                                                                                                                                   
   return [...prev.slice(0, -1), newEntry, lastEntry];                                                                                                                                                                                                                        
 }                                                                                                                                                                                                                                                                            
 ```                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                              
 But the text input handler at **line 759** uses a naive append:                                                                                                                                                                                                              
 ```typescript                                                                                                                                                                                                                                                                
 setTranscript((prev) => [                                                                                                                                                                                                                                                    
   ...prev,                                                                                                                                                                                                                                                                   
   { speaker: "respondent", text: textInput.trim(), timestamp: Date.now() },                                                                                                                                                                                                  
 ]);                                                                                                                                                                                                                                                                          
 ```                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                              
 **Impact:** If the AI is still streaming a response when the user submits text (possible during long AI responses or slow connections), the user's text message will appear *after* the AI's streaming entry in the transcript. This is the same race condition that was     
 fixed for voice in `d193b46`.                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                              
 **Recommendation:** Apply the same reordering logic used for voice transcripts:                                                                                                                                                                                              
                                                                                                                                                                                                                                                                              
 ```typescript                                                                                                                                                                                                                                                                
 setTranscript((prev) => {                                                                                                                                                                                                                                                    
   const newEntry = {                                                                                                                                                                                                                                                         
     speaker: "respondent" as const,                                                                                                                                                                                                                                          
     text: textInput.trim(),                                                                                                                                                                                                                                                  
     timestamp: Date.now(),                                                                                                                                                                                                                                                   
   };                                                                                                                                                                                                                                                                         
   const lastEntry = prev[prev.length - 1];                                                                                                                                                                                                                                   
   if (lastEntry && lastEntry.speaker === "alvia" && lastEntry.isStreaming) {                                                                                                                                                                                                 
     return [...prev.slice(0, -1), newEntry, lastEntry];                                                                                                                                                                                                                      
   }                                                                                                                                                                                                                                                                          
   return [...prev, newEntry];                                                                                                                                                                                                                                                
 });                                                                                                                                                                                                                                                                          
 ```                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                              
 ---                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                              
 ### Issue 3: No Duplicate Message Prevention (Medium Priority)                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                              
 **File:** `client/src/pages/interview.tsx:748-778`                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                              
 Since `isSendingText` is effectively broken (Issue 1), and `textInput` is cleared synchronously after the WebSocket send, there is a brief window where a user holding Enter could trigger `handleTextKeyDown` multiple times in the same event loop tick. The               
 `textInput.trim()` guard on line 750 should catch most cases since `setTextInput("")` is called, but React state updates are asynchronous — the next keydown event may still see the old `textInput` value.                                                                  
                                                                                                                                                                                                                                                                              
 **Impact:** Potential for duplicate messages under rapid input, especially on slower devices.                                                                                                                                                                                
                                                                                                                                                                                                                                                                              
 **Recommendation:** Clear the input *before* sending to the server, and use a ref-based guard:                                                                                                                                                                               
                                                                                                                                                                                                                                                                              
 ```typescript                                                                                                                                                                                                                                                                
 const handleSendText = () => {                                                                                                                                                                                                                                               
   const text = textInput.trim();                                                                                                                                                                                                                                             
   if (!text || !wsRef.current || wsRef.current.readyState !== WebSocket.OPEN) return;                                                                                                                                                                                        
                                                                                                                                                                                                                                                                              
   setTextInput("");  // Clear first to prevent duplicates from queued events                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                              
   // ... add to transcript and send via WebSocket                                                                                                                                                                                                                            
 };                                                                                                                                                                                                                                                                           
 ```                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                              
 Alternatively, use a ref (`sendingRef.current = true`) that updates synchronously, unlike state.                                                                                                                                                                             
                                                                                                                                                                                                                                                                              
 ---                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                              
 ### Issue 4: No Error Handling for WebSocket Send Failures (Low Priority)                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                              
 **File:** `client/src/pages/interview.tsx:769-774`                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                              
 The text is added to the transcript optimistically (line 759), then sent over WebSocket (line 769). If the WebSocket connection drops between the `readyState` check (line 752) and the actual `.send()` call, the message will appear in the user's transcript but never    
 reach the server. The user would see their message in the chat but the AI would never respond to it.                                                                                                                                                                         
                                                                                                                                                                                                                                                                              
 **Impact:** Ghost messages in the transcript that the AI never sees. The user may think the AI is ignoring them.                                                                                                                                                             
                                                                                                                                                                                                                                                                              
 **Recommendation:** Wrap the send in a try/catch and remove the transcript entry on failure:                                                                                                                                                                                 
                                                                                                                                                                                                                                                                              
 ```typescript                                                                                                                                                                                                                                                                
 try {                                                                                                                                                                                                                                                                        
   wsRef.current.send(JSON.stringify({ type: "text_input", text }));                                                                                                                                                                                                          
 } catch (err) {                                                                                                                                                                                                                                                              
   // Remove the optimistic transcript entry                                                                                                                                                                                                                                  
   setTranscript((prev) => prev.slice(0, -1));                                                                                                                                                                                                                                
   toast({ title: "Failed to send message", description: "Please try again.", variant: "destructive" });                                                                                                                                                                      
 }                                                                                                                                                                                                                                                                            
 ```                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                              
 ---                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                              
 ### Issue 5: No Server Acknowledgment of Text Input (Low Priority)                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                              
 **File:** `server/voice-interview.ts:1806-1880`                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                              
 For voice input, the server sends a `user_transcript` message back to the client after processing (line 1492), which the client uses for ordering. For text input, no such acknowledgment exists. The client has no way to know if the server received and processed the     
 text message.                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                              
 **Impact:** Currently this manifests as Issue 2 (ordering), but it also means the client cannot distinguish between "server is processing my text" and "server never received my text." This makes robust error handling difficult.                                          
                                                                                                                                                                                                                                                                              
 **Recommendation (longer-term):** Add a `text_input_ack` message from the server:                                                                                                                                                                                            
                                                                                                                                                                                                                                                                              
 ```typescript                                                                                                                                                                                                                                                                
 // In server text_input handler, after processing:                                                                                                                                                                                                                           
 state.clientWs?.send(JSON.stringify({                                                                                                                                                                                                                                        
   type: "text_input_ack",                                                                                                                                                                                                                                                    
   text: message.text,                                                                                                                                                                                                                                                        
   timestamp: Date.now(),                                                                                                                                                                                                                                                     
 }));                                                                                                                                                                                                                                                                         
 ```                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                              
 This would also allow the client to switch from optimistic updates to confirmed updates if desired.                                                                                                                                                                          
                                                                                                                                                                                                                                                                              
 ---                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                              
 ### Issue 6: TranscriptPanel Uses Array Index as React Key (Cosmetic/Low Priority)                                                                                                                                                                                           
                                                                                                                                                                                                                                                                              
 **File:** `client/src/pages/interview.tsx:162`                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                              
 ```tsx                                                                                                                                                                                                                                                                       
 {entries.map((entry, index) => (                                                                                                                                                                                                                                             
   <div key={index} ...>                                                                                                                                                                                                                                                      
 ```                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                              
 When transcript entries are reordered (as happens with the voice ordering fix at line 480), using array index as key causes React to update the wrong DOM nodes. This can result in brief visual flickers — a bubble's content changes in place rather than the bubble being 
  moved.                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                              
 **Impact:** Minor visual glitch during reordering. Messages may briefly show the wrong styling (respondent style with AI text or vice versa) before React reconciles.                                                                                                        
                                                                                                                                                                                                                                                                              
 **Recommendation:** Use a stable identifier, such as a composite key:                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                              
 ```tsx                                                                                                                                                                                                                                                                       
 <div key={`${entry.speaker}-${entry.timestamp}-${index}`} ...>                                                                                                                                                                                                               
 ```                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                              
 Or better, assign a unique ID when creating each `TranscriptEntry`.                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                              
 ---                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                              
 ## Priority Summary                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                              
 | # | Issue | Priority | Effort |                                                                                                                                                                                                                                            
 |---|-------|----------|--------|                                                                                                                                                                                                                                            
 | 1 | `isSendingText` is a no-op | High | Small — remove or replace with ref |                                                                                                                                                                                               
 | 2 | Text input bypasses ordering logic | High | Small — copy existing pattern from voice handler |                                                                                                                                                                         
 | 3 | No duplicate message prevention | Medium | Small — clear input first, or add ref guard |                                                                                                                                                                               
 | 4 | No WebSocket send error handling | Low | Small — add try/catch |                                                                                                                                                                                                       
 | 5 | No server acknowledgment for text | Low | Medium — add new message type |                                                                                                                                                                                              
 | 6 | Array index as React key | Low | Small — use stable key |                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                              
 ---                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                              
 ## Recommended Fix Order                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                              
 1. **Fix Issues 1 + 2 + 3 together** — These are interrelated and can be resolved in a single update to `handleSendText`. The fix is ~15 lines of code.                                                                                                                      
 2. **Fix Issue 6** — One-line change, prevents visual glitches during reordering.                                                                                                                                                                                            
 3. **Fix Issue 4** — Small try/catch addition for robustness.                                                                                                                                                                                                                
 4. **Fix Issue 5** — Requires server + client changes, should be part of a broader reliability pass. 