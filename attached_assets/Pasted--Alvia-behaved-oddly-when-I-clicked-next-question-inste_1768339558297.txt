❯ Alvia behaved oddly when I clicked next question, instead of asking the next template question, she asked a random 
  question about connection with life or relationships. How is the next template question injected into the system   
  prompt when this button is clicked? Is there potentially a race condition issue?                                   

● Let me investigate the voice interview handler to understand the question injection flow.

● Read(server/voice-interview.ts)
  ⎿  Read 1286 lines

● I found the issue. There's a race condition in the next_question handler (lines 1118-1260).

  The Problem

  When "Next Question" is clicked, the code does this:

  // Line 1183-1189: Send session.update with new instructions
  state.openaiWs.send(JSON.stringify({
    type: "session.update",
    session: { instructions: instructions },
  }));

  // Line 1191-1199: Immediately send response.create
  state.openaiWs.send(JSON.stringify({
    type: "response.create",
    response: { modalities: ["text", "audio"] },
  }));

  The race: Both WebSocket send() calls are fire-and-forget. There's no guarantee OpenAI has received and applied the new session.update instructions before it processes the response.create.

  If OpenAI processes response.create before the session.update is fully applied, Alvia responds using stale instructions from the previous question—or worse, a partially-applied state that causes hallucination.

  Evidence in the Code

  Look at lines 651-671 in the session.updated handler:

  case "session.updated":
    // Only trigger response on initial session setup, not Barbara guidance updates
    if (state.isInitialSession && ...) {
      state.isInitialSession = false;
      state.openaiWs.send(JSON.stringify({ type: "response.create", ... }));
    }

  For the initial session, the code correctly waits for session.updated before triggering response.create. But for subsequent question transitions (lines 1183-1199), it fires both messages immediately without waiting.

  The Fix

  The next_question handler should wait for session.updated before sending response.create. A pattern like:

  1. Set a flag like state.pendingQuestionTransition = targetQuestionIndex
  2. Send session.update
  3. In the session.updated handler, check if pendingQuestionTransition is set
  4. Only then send response.create and clear the flag